name: shigaplaza-monitor

on:
  schedule:
    - cron: "0,30 * * * *"    # 30分おき
    - cron: "12 0 1 * *"      # 毎月1日 00:12 UTCにハートビート
  workflow_dispatch: {}

jobs:
  run:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      SMTP_HOST: smtp.gmail.com
      SMTP_PORT: "587"
      SMTP_SENDER: ${{ secrets.SMTP_SENDER }}
      SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
      RECIPIENT_EMAIL: "57180928miwa@gmail.com"

    steps:
      - name: Checkout code (main)
        uses: actions/checkout@v4
        with: { ref: main }

      - name: Checkout state branch
        uses: actions/checkout@v4
        with:
          ref: state
          path: state

      - name: Restore DB from state branch (if exists)
        run: |
          if [ -f state/shigaplaza.db ]; then
            cp state/shigaplaza.db ./shigaplaza.db
            echo "[info] restored DB from state"
          else
            echo "[info] no DB in state"
          fi

      - name: Setup Python
        uses: actions/setup-python@v5
        with: { python-version: "3.11" }

      - name: Install deps
        run: pip install requests beautifulsoup4 lxml

      # —— 初回確認メール（1回限り）| 失敗しても続行 ——
      - name: One-time confirmation mail if not yet sent
        continue-on-error: true
        run: |
          if [ ! -f state/CONFIRMED.txt ]; then
            cat > send_confirm.py <<'PY'
import os, smtplib, traceback
from email.message import EmailMessage
try:
    host=os.environ.get("SMTP_HOST","smtp.gmail.com")
    port=int(os.environ.get("SMTP_PORT","587"))
    user=os.environ.get("SMTP_SENDER","")
    pw  =os.environ.get("SMTP_PASSWORD","")
    to  =os.environ.get("RECIPIENT_EMAIL","")
    assert user and pw and to, f"missing env user={bool(user)} pw={bool(pw)} to={bool(to)}"
    msg=EmailMessage()
    msg["Subject"]="【滋賀プラザ】監視システム 起動確認（初回のみ）"
    msg["From"]=f"滋賀プラザ監視 <{user}>"
    msg["To"]=to
    msg.set_content("監視ジョブが起動しました（初回のみ送信）。以降は新着/更新があった時だけ届きます。")
    with smtplib.SMTP(host, port, timeout=20) as s:
        s.ehlo(); s.starttls(); s.ehlo()
        s.login(user, pw)
        s.send_message(msg)
    print("sent confirmation")
except Exception as e:
    print("[warn] confirmation mail failed:", e)
    traceback.print_exc()
PY
            python send_confirm.py || true
            date -u +"%Y-%m-%dT%H:%M:%SZ" > state/CONFIRMED.txt
            git -C state config user.name "github-actions[bot]"
            git -C state config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git -C state add CONFIRMED.txt
            git -C state commit -m "chore(state): add confirmation marker" || true
            git -C state push origin state
          else
            echo "[info] confirmation already sent (state/CONFIRMED.txt exists)"
          fi

      - name: Run monitor
        run: python monitor_shigaplaza.py

      - name: Save DB back to state branch if changed
        run: |
          mkdir -p state
          if [ -f ./shigaplaza.db ]; then
            if [ ! -f state/shigaplaza.db ] || ! cmp -s ./shigaplaza.db state/shigaplaza.db; then
              cp ./shigaplaza.db state/shigaplaza.db
              cd state
              git config user.name "github-actions[bot]"
              git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
              git add shigaplaza.db
              git commit -m "chore(state): update DB" || true
              git push origin state
            fi
          fi

      - name: Monthly heartbeat commit (only on 12 0 1 * * schedule)
        if: github.event.schedule == '12 0 1 * *'
        run: |
          mkdir -p state
          date -u +"%Y-%m-%dT%H:%M:%SZ" > state/HEARTBEAT.txt
          cd state
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add HEARTBEAT.txt
          git commit -m "chore(state): monthly heartbeat" || true
          git push origin state
